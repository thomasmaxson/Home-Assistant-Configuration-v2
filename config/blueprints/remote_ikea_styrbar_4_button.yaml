# This blueprint uses an IKEA STYRBAR Remote Control connected through ZHA or MQTT.
#
# | Button               | Action       | Event                                        |
# | -------------------- | ------------ | -------------------------------------------- |
# | Brightness, Increase | Press        | Increase brightness (once) OR custom action  |
# | Brightness, Increase | Press & Hold | Increase brightness (repeat) OR custom event |
# | Brightness, Decrease | Press        | Decrease brightness (once) OR custom action  |
# | Brightness, Decrease | Press & Hold | Decrease brightness (repeat) OR custom event |
# | Arrow, Left          | Press        | Custom event                                 |
# | Arrow, Left          | Press & Hold | Custom event                                 |
# | Arrow, Right         | Press        | Custom event                                 |
# | Arrow, Right         | Press & Hold | Cusotm event                                 |
# | -------------------- | ------------ | -------------------------------------------- |

blueprint:
  name: IKEA STYRBAR, 4 Button Remote Control
  description: Control devices with your IKEA STYRBAR 4 button remote.
  author: Thomas Maxson
  source_url: https://gist.github.com/thomasmaxson/b494e0d0a67a7ed940188c30eedeb7fa
  homeassistant:
    min_version: 2024.6.0
  domain: automation
  input:
    remote:
      name: IKEA STYRBAR Remote
      description: Select the remote control you wish to use.
      selector:
        device:
          multiple: false
          filter:
            - integration: mqtt
              manufacturer: IKEA
              model: STYRBAR remote control
            - integration: zha
              manufacturer: IKEA of Sweden
              model: Remote Control N2

    light:
      name: Light(s)
      description: Select the light entities you wish to control.
      default: []
      selector:
        entity:
          multiple: true
          filter:
            domain: light

    light_config:
      name: Light Configuration
      icon: mdi:lightbulb-on
      collapsed: true
      input:
        brightness:
          name: Brightness
          description: >-
            Brightness of the light(s) when turning on.
            <br>&bull; Set 1-100 to use a specific brightness level
            <br>&bull; Set to 0 to use the lights last brightness level
          selector:
            number:
              mode: slider
              unit_of_measurement: "%"
              min: 0
              max: 100.0
              step: 1.0
          default: 0

        brightness_step:
          name: Brightness Step
          description: Incremental value to increase or decrease lights brightness.
          selector:
            number:
              mode: slider
              unit_of_measurement: "%"
              min: 5
              max: 100
              step: 5.0
          default: 20

        repeat_delay:
          name: Repeat Delay
          description: Delay between the brightness adjustment steps.
          selector:
            number:
              mode: slider
              unit_of_measurement: seconds
              min: 0.25
              max: 5
              step: 0.25
          default: 1

        repeat_max_count:
          name: Maximum loop repeats
          description: >-
            Maximum number of times to repeat the dimmer brightness event(s).
            <br>&bull; Used as a safety limit to prevent an endless loop, just in case the corresponding stop event is not received.
          default: 10
          selector:
            number:
              min: 1
              max: 100
              mode: slider
              step: 1

    default_button_events:
      name: Left/Right Arrow Button Events
      icon: mdi:code-tags
      collapsed: true
      input:
        event_button_press_left_single:
          name: Left Arrow Button Press Event
          description: The action to perform on _press_ of the **Left Arrow Button**.
          default: []
          selector:
            action: null

        event_button_press_left_hold:
          name: Left Arrow Button Press and Hold Event
          description: >
            The action to perform on _press and hold_ of the **Left Arrow Button**.
            <br>Use with care, before the _press and hold_ event, this buttons _press_ event gets triggered.
          default: []
          selector:
            action: null

        event_button_press_right_single:
          name: Right Arrow Button Press Event
          description: The action to perform on _press_ of the **Right Arrow Button**.
          default: []
          selector:
            action: null

        event_button_press_right_hold:
          name: Right Arrow Button Press and Hold Event
          description: >
            The action to perform on _press and hold_ of the **Right Arrow Button**.
            <br>Use with care, before the _press and hold_ event, this buttons _press_ event gets triggered.
          default: []
          selector:
            action: null

    override_button_events:
      name: Override Brightness Button Events
      description: Define custom actions to override the default light control actions.
      icon: mdi:sync-alert
      collapsed: true
      input:
        event_button_press_raise_single:
          name: Override Brightness Increase Button Press Event
          description: The action to perform on _press_ of the **Brightness Increase Button**.
          default: []
          selector:
            action: null

        event_button_press_raise_hold:
          name: Override Brightness Increase Button Press and Hold Event
          description: >-
            The action to perform on _press and hold_ of the **Brightness Increase Button**.
            <br>Use with care, before the _press and hold_ event, this buttons _press_ event gets triggered.
          default: []
          selector:
            action: null

        event_button_press_lower_single:
          name: Override Brightness Decrease Button Press Event
          description: The action to perform on _press_ of the **Brightness Decrease Button**.
          default: []
          selector:
            action: null

        event_button_press_lower_hold:
          name: Override Brightness Decrease Button Press and Hold Event
          description: >
            The action to perform on _press and hold_ of the **Brightness Decrease Button**.
            <br>Use with care, before the _press and hold_ event, this buttons _press_ event gets triggered.
          default: []
          selector:
            action: null

    automation_config:
      name: Configuration
      icon: mdi:cog
      collapsed: true
      input:
        config_mode:
          name: Automation Mode
          description: Mode that automation runs in.
          default: restart
          selector:
            select:
              options:
                - single
                - restart
                - queued
                - parallel
              custom_value: false
              multiple: false

        config_max_num:
          name: Mode Max
          description: >
            Maximum number of runs that can be executed or queued at a time.
            <br>Ignored by _Single_ and _Restart_ Modes.
          default: 10
          selector:
            number:
              mode: slider
              unit_of_measurement: runs
              min: 1.0
              max: 15.0
              step: 1.0

        debug_valid_events:
          name: Debug Remote
          description: Display a persistent notification, with remote and event details, if triggered.
          default: false
          selector:
            boolean:


mode: !input config_mode
max: !input config_max_num
max_exceeded: silent


variables:
  var_remote: !input remote
  var_light: !input light
  var_brightness: !input brightness
  var_brightness_step: !input brightness_step
  var_repeat_delay: !input repeat_delay
  var_repeat_max_count: !input repeat_max_count


triggers:
  - alias: Brightness Increase Button Press (via ZHA event)
    trigger: event
    event_type: zha_event
    event_data:
      device_id: !input remote
      command: "on"
    id: trigger_raise_single_press_zha
  - alias: Brightness Increase Button Press (via MQTT event)
    trigger: device
    domain: mqtt
    device_id: !input remote
    type: action
    subtype: "on"
    id: trigger_raise_single_press_mqtt

  - alias: Brightness Increase Button Press and Hold (via ZHA event)
    trigger: event
    event_type: zha_event
    event_data:
      device_id: !input remote
      command: "move_with_on_off"
    id: trigger_raise_hold_press_zha
  - alias: Brightness Increase Button Press and Hold (via MQTT event)
    trigger: device
    domain: mqtt
    device_id: !input remote
    type: action
    subtype: "brightness_move_up"
    id: trigger_raise_hold_press_mqtt

  - alias: Brightness Increase Button Release (via ZHA event)
    trigger: event
    event_type: zha_event
    event_data:
      device_id: !input remote
      command: "stop_with_on_off"
    id: trigger_raise_release_zha
  - alias: Brightness Increase Button Release (via MQTT event)
    trigger: device
    domain: mqtt
    device_id: !input remote
    type: action
    subtype: "brightness_stop"
    id: trigger_raise_release_mqtt


  - alias: Brightness Decrease Button Press (via ZHA event)
    trigger: event
    event_type: zha_event
    event_data:
      device_id: !input remote
      command: "off"
    id: trigger_lower_single_press_zha
  - alias: Brightness Decrease Button Press (via MQTT event)
    trigger: device
    domain: mqtt
    device_id: !input remote
    type: action
    subtype: "off"
    id: trigger_lower_single_press_mqtt

  - alias: Brightness Decrease Button Press and Hold (via ZHA event)
    trigger: event
    event_type: zha_event
    event_data:
      device_id: !input remote
      command: "move"
    id: trigger_lower_hold_press_zha
  - alias: Brightness Decrease Button Press and Hold (via MQTT event)
    trigger: device
    domain: mqtt
    device_id: !input remote
    type: action
    subtype: "brightness_move_down"
    id: trigger_lower_hold_press_mqtt

  - alias: Brightness Decrease Button Release (via ZHA event)
    trigger: event
    event_type: zha_event
    event_data:
      device_id: !input remote
      command: "stop_with_on_off"
    id: trigger_lower_release_zha
  - alias: Brightness Decrease Button Release (via MQTT event)
    trigger: device
    domain: mqtt
    device_id: !input remote
    type: action
    subtype: "brightness_stop"
    id: trigger_lower_release_mqtt


  - alias: Left Arrow Button Press (via ZHA event)
    trigger: event
    event_type: zha_event
    event_data:
      device_id: !input remote
      command: "press"
      args: [257, 13, 0]
    id: trigger_left_single_press_zha
  - alias: Left Button Press (via MQTT event)
    trigger: device
    domain: mqtt
    device_id: !input remote
    type: action
    subtype: "arrow_left_click"
    id: trigger_left_single_press_mqtt

  - alias: Left Arrow Button Press and Hold (via ZHA event)
    trigger: event
    event_type: zha_event
    event_data:
      device_id: !input remote
      command: "hold"
      args: [3329, 0]
    id: trigger_left_hold_press_zha
  - alias: Left Arrow Button Press and Hold (via MQTT event)
    trigger: device
    domain: mqtt
    device_id: !input remote
    type: action
    subtype: "arrow_left_hold"
    id: trigger_left_hold_press_mqtt

  - alias: Left Arrow Button Release (via ZHA event)
    trigger: event
    event_type: zha_event
    event_data:
      device_id: !input remote
      command: "release"
    id: trigger_left_release_zha
  - alias: Left Arrow Button Release (via MQTT event)
    trigger: device
    domain: mqtt
    device_id: !input remote
    type: action
    subtype: "arrow_left_release"
    id: trigger_left_release_mqtt


  - alias: Right Arrow Button Press (via ZHA event)
    trigger: event
    event_type: zha_event
    event_data:
      device_id: !input remote
      command: "press"
      args: [255, 13, 0]
    id: trigger_right_single_press_zha
  - alias: Right Arrow Button Press (via ZHA event)
    trigger: device
    domain: mqtt
    device_id: !input remote
    type: action
    subtype: "arrow_right_click"
    id: trigger_right_single_press_mqtt

  - alias: Right Arrow Button Press and Hold (via ZHA event)
    trigger: event
    event_type: zha_event
    event_data:
      device_id: !input remote
      command: "hold"
      args: [3328, 0]
    id: trigger_right_hold_press_zha
  - alias: Right Arrow Button Press and Hold (via MQTT event)
    trigger: device
    domain: mqtt
    device_id: !input remote
    type: action
    subtype: "arrow_right_hold"
    id: trigger_right_hold_press_mqtt

  - alias: Right Arrow Button Release (via ZHA event)
    trigger: event
    event_type: zha_event
    event_data:
      device_id: !input remote
      command: "release"
    id: trigger_right_release_zha
  - alias: Right Arrow Button Release (via MQTT event)
    trigger: device
    domain: mqtt
    device_id: !input remote
    type: action
    subtype: "arrow_right_release"
    id: trigger_right_release_mqtt


conditions:
  - alias: "Check if remote to use is set"
    condition: template
    value_template: "{{ var_remote | length > 0 }}"


actions:
  - alias: "Maybe display debug notification"
    if:
      - alias: "Confirm debug remote is active"
        condition: template
        value_template: !input debug_valid_events
    then:
      - alias: "Setup debug variables"
        variables:
          device_manufacturer: "{{ device_attr( var_remote, 'manufacturer' ) | string }}"
          device_model: "{{ device_attr( var_remote, 'model' ) | string }}"
          device_model_id: "{{ device_attr( var_remote, 'model_id' ) | string }}"
          device_identifiers: "{{ device_attr( var_remote, 'identifiers' ) | list }}"
          device_integration: "{{ device_identifiers[0][0] | string | lower }}"
          trigger_action: >-
            {%- if device_integration == "zha" -%}
              {{ trigger.event.data.command }}
            {%- elif device_integration == "mqtt" -%}
              {{ trigger.payload }}
            {%- endif -%}
          trigger_data: >-
            {%- if device_integration == "zha" -%}
              {{ trigger.event.data }}
            {%- elif device_integration == "mqtt" -%}
              {{ trigger }}
            {%- endif -%}

      - alias: "Display debug notification with remote and event details"
        action: persistent_notification.create
        data:
          notification_id: blueprint_debug__remote_ikea_styrbar_4_button
          title: >-
            {%- if device_model_id not in [ "", "none", none, null, false] -%}
              {{ device_manufacturer + " " + device_model }} ({{ device_model_id }})
            {%- else -%}
              {{ device_manufacturer + " " + device_model }}
            {%- endif -%}
          message: >-
            <br>_Integration_: {{ device_integration }}  |  _Action_: {{ trigger_action }}
            <br>
            <br>_Remote ID_: {{ var_remote }}
            <br>
            <br>```{{ trigger_data }}```

  - alias: "Determine button event to execute"
    choose:
      - alias: "Button: Increase Brightness, Press"
        conditions:
          - alias: "Check if triggered by Brightness Increase button press"
            condition: trigger
            id:
              - trigger_raise_single_press_zha
              - trigger_raise_single_press_mqtt
        sequence:
          - alias: "Turn on light(s) if set, otherwise execute custom action"
            if:
              - alias: "Check if light(s) to be controlled are set"
                condition: template
                value_template: "{{ var_light | length > 0 }}"
            then:
              - alias: "Determine how to turn on light(s)"
                if:
                  - alias: "Check if light brightness option is greater than 0"
                    condition: template
                    value_template: "{{ var_brightness | int > 0 }}"
                then:
                  - alias: "Turn on light(s) with the set brightness option"
                    action: light.turn_on
                    target:
                      entity_id: >-
                        {{ expand( var_light ) | selectattr( "state", "eq", "off" ) | map( attribute = "entity_id" ) | list }}
                    data:
                      brightness_pct: !input brightness
                else:
                  - alias: "Turn on light(s)"
                    action: light.turn_on
                    target:
                      entity_id: >-
                        {{ expand( var_light ) | selectattr( "state", "eq", "off" ) | map( attribute = "entity_id" ) | list }}
            else: !input event_button_press_raise_single

      - alias: "Button: Increase Brightness, Press and Hold"
        conditions:
          - alias: "Check if triggered by Brightness Increase button press and hold"
            condition: trigger
            id: 
              - trigger_raise_hold_press_zha
              - trigger_raise_hold_press_mqtt
        sequence:
          - alias: "Increase brightness for light(s) if set, otherwise execute custom action"
            if:
              - alias: "Check if light(s) to be controlled are set"
                condition: template
                value_template: "{{ var_light | length > 0 }}"
            then:
              - alias: "Repeat brightness increase for the light(s) that are on"
                repeat:
                  until:
                    - alias: "Check if triggered by button press"
                      condition: trigger
                      id: 
                        - trigger_raise_release_zha
                        - trigger_raise_release_mqtt
                    - alias: "Check if the maximum repeat count reached"
                      condition: template
                      value_template: "{{ repeat.index > var_repeat_max_count | int }}"
                    - alias: "Wait for button to be released"
                      condition: template
                      value_template: "{{ wait.trigger is not none }}"
                  sequence:
                    - alias: "Increase brightness for light(s) that are on"
                      action: light.turn_on
                      target:
                        entity_id: >-
                          {{ expand( var_light ) | selectattr( "state", "eq", "on" ) | map( attribute = "entity_id" ) | list }}
                      data:
                        brightness_step_pct: "{{ var_brightness_step * 1 | int }}"
                    - alias: "Delay between brightness increase steps"
                      delay:
                        seconds: "{{ var_repeat_delay | float }}"
            else: !input event_button_press_raise_hold

      - alias: "Button: Decrease Brightness, Press"
        conditions:
          - alias: "Check if triggered by button press"
            condition: trigger
            id: 
              - trigger_lower_single_press_zha
              - trigger_lower_single_press_mqtt
        sequence:
          - alias: "Turn off light(s) if set, otherwise execute custom action"
            if:
              - alias: "Check if light(s) to be controlled are set"
                condition: template
                value_template: "{{ var_light | length > 0 }}"
            then:
              - alias: "Turn off light(s)"
                action: light.turn_off
                target:
                  entity_id: >-
                    {{ expand( var_light ) | selectattr( "state", "eq", "on" ) | map( attribute = "entity_id" ) | list }}
            else: !input event_button_press_lower_single

      - alias: "Button: Decrease Brightness, Press and Hold"
        conditions:
          - alias: "Check if triggered by button press"
            condition: trigger
            id: 
              - trigger_lower_hold_press_zha
              - trigger_lower_hold_press_mqtt
        sequence:
          - alias: "Decrease brightness for light(s) if set, otherwise execute custom action"
            if:
              - alias: "Check if light(s) to be controlled are set"
                condition: template
                value_template: "{{ var_light | length > 0 }}"
            then:
              - alias: "Repeat brightness decrease for the light(s) that are on"
                repeat:
                  until:
                    - alias: "Check if triggered by button press"
                      condition: trigger
                      id: 
                        - trigger_lower_release_zha
                        - trigger_lower_release_mqtt
                    - alias: "Check if the maximum repeat count reached"
                      condition: template
                      value_template: "{{ repeat.index > var_repeat_max_count | int }}"
                    - alias: "Wait for button to be released"
                      condition: template
                      value_template: "{{ wait.trigger is not none }}"
                  sequence:
                    - alias: "Decrease brightness for light(s) that are on"
                      action: light.turn_on
                      target:
                        entity_id: >-
                          {{ expand( var_light ) | selectattr( "state", "eq", "on" ) | map( attribute = "entity_id" ) | list }}
                      data:
                        brightness_step_pct: "{{ var_brightness_step * -1 | int }}"
                    - alias: "Delay between brightness decrease steps"
                      delay:
                        seconds: "{{ var_repeat_delay | float }}"
            else: !input event_button_press_lower_hold

      - alias: "Button: Left Arrow, Press"
        conditions:
          - alias: "Check if triggered by Left Arrow button press"
            condition: trigger
            id: 
              - trigger_left_single_press_zha
              - trigger_left_single_press_mqtt
        sequence: !input event_button_press_left_single

      - alias: "Button: Left Arrow, Press and Hold"
        conditions:
          - alias: "Check if triggered by Left Arrow button press and hold"
            condition: trigger
            id: 
              - trigger_left_hold_press_zha
              - trigger_left_hold_press_mqtt
        sequence: !input event_button_press_left_hold

      - alias: "Button: Right Arrow, Press"
        conditions:
          - alias: "Check if triggered by Right Arrow button press"
            condition: trigger
            id: 
              - trigger_right_single_press_zha
              - trigger_right_single_press_mqtt
        sequence: !input event_button_press_right_single

      - alias: "Button: Right Arrow, Press and Hold"
        conditions:
          - alias: "Check if triggered by Right Arrow button press and hold"
            condition: trigger
            id: 
              - trigger_right_hold_press_zha
              - trigger_right_hold_press_mqtt
        sequence: !input event_button_press_right_hold
